(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Z="modulepreload",ee=function(l){return"/rustpotter-worklet-demo/"+l},D={},te=function(e,n,a){if(!n||n.length===0)return e();const i=document.getElementsByTagName("link");return Promise.all(n.map(s=>{if(s=ee(s),s in D)return;D[s]=!0;const d=s.endsWith(".css"),b=d?'[rel="stylesheet"]':"";if(!!a)for(let u=i.length-1;u>=0;u--){const m=i[u];if(m.href===s&&(!d||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${b}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Z,d||(h.as="script",h.crossOrigin=""),h.href=s,document.head.appendChild(h),d)return new Promise((u,m)=>{h.addEventListener("load",u),h.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>e())},re=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});re.decode();const j=new Array(128).fill(void 0);j.push(void 0,null,!0,!1);j.length;const N=new TextEncoder("utf-8");N.encodeInto;const p=Object.freeze({max:0,0:"max",avg:1,1:"avg",median:2,2:"median",p25:3,3:"p25",p50:4,4:"p50",p75:5,5:"p75",p80:6,6:"p80",p90:7,7:"p90",p95:8,8:"p95"});function _(l,e,n,a){function i(s){return s instanceof n?s:new n(function(d){d(s)})}return new(n||(n=Promise))(function(s,d){function b(u){try{h(a.next(u))}catch(m){d(m)}}function y(u){try{h(a.throw(u))}catch(m){d(m)}}function h(u){u.done?s(u.value):i(u.value).then(b,y)}h((a=a.apply(l,e||[])).next())})}class L{constructor(e={},n){if(this.customSourceNode=n,this.defaultCallback=({data:a})=>{switch(a.type){case"detection":const{detection:i}=a;return this.onspot(i)}},this.onpause=()=>{},this.onresume=()=>{},this.onstart=()=>{},this.onstop=()=>{},this.onspot=a=>{},!L.isRecordingSupported())throw new Error("Recording is not supported in this browser");this.state="inactive",this.config=Object.assign({workletPath:"/rustpotterWorker.js",wasmPath:"/rustpotter_wasm_bg.wasm",monitorGain:0,recordingGain:1,minScores:5,threshold:.5,averagedThreshold:.25,comparatorRef:.22,comparatorBandSize:6,scoreMode:p.max,gainNormalizerEnabled:!1,minGain:.1,maxGain:1,gainRef:void 0,bandPassEnabled:!1,bandPassLowCutoff:85,bandPassHighCutoff:400},e)}static isRecordingSupported(){const e=window.navigator&&window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia;return AudioContext&&e&&window.WebAssembly}clearStream(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(e=>e.stop()):this.stream.stop())}close(){return this.sourceNode&&this.sourceNode.disconnect(),this.clearStream(),this.processor&&(this.processorNode.disconnect(),this.processor.postMessage({command:"close"})),!this.customSourceNode&&this.audioContext?this.audioContext.close():Promise.resolve()}postBuffers(e){if(this.state==="recording"){const n=[];for(let a=0;a<e.numberOfChannels;a++)n[a]=e.getChannelData(a);this.processor.postMessage({command:"process",buffers:n})}}initAudioContext(){var e;const n=window.AudioContext||global.webkitAudioContext;this.audioContext=!((e=this.customSourceNode)===null||e===void 0)&&e.context?this.customSourceNode.context:new n}registerWorker(e){return _(this,void 0,void 0,function*(){e.audioWorklet?(yield e.audioWorklet.addModule(this.config.workletPath),this.processorNode=new AudioWorkletNode(e,"rustpotter-worklet",{numberOfOutputs:0}),this.processor=this.processorNode.port):(console.log("audioWorklet support not detected. Falling back to scriptProcessor"),this.processorNode=e.createScriptProcessor(4096,1,1),this.processorNode.onaudioprocess=({inputBuffer:n})=>this.postBuffers(n),this.processorNode.connect(e.destination),this.processor=new window.Worker(this.config.workletPath))})}initSourceNode(){return this.customSourceNode?(this.sourceNode=this.customSourceNode,Promise.resolve()):window.navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>{this.stream=e,this.sourceNode=this.audioContext.createMediaStreamSource(e)})}setupListener(){this.processor.removeEventListener("message",this.defaultCallback),this.processor.addEventListener("message",this.defaultCallback)}initWorker(e){return new Promise((n,a)=>{const i=({data:s})=>{switch(s.type){case"rustpotter-ready":return this.processor.removeEventListener("message",i),this.setupListener(),n();case"rustpotter-error":return this.processor.removeEventListener("message",i),a(new Error("Unable to start rustpotter worklet"))}};try{this.processor.addEventListener("message",i),this.processor.start&&this.processor.start(),this.fetchResource(this.config.wasmPath).then(s=>this.processor.postMessage(Object.assign({command:"init",wasmBytes:s,sampleRate:e.sampleRate},this.config)))}catch(s){a(s)}})}getProcessorNode(e){return _(this,void 0,void 0,function*(){return this.state="external",yield this.registerWorker(e),yield this.initWorker(e),this.processorNode})}pause(){return this.state==="recording"&&(this.state="paused",this.sourceNode.disconnect(),this.onpause()),Promise.resolve()}resume(){this.state==="paused"&&(this.state="recording",this.sourceNode.connect(this.processorNode),this.onresume())}start(){return this.state==="inactive"?(this.state="loading",this.initAudioContext(),this.audioContext.resume().then(()=>this.registerWorker(this.audioContext)).then(()=>Promise.all([this.initSourceNode(),this.initWorker(this.audioContext)])).then(()=>{this.state="recording",this.sourceNode.connect(this.processorNode),this.onstart()}).catch(e=>{throw this.state="inactive",e})):Promise.resolve()}stop(){return this.state==="paused"||this.state==="recording"?(this.state="inactive",this.sourceNode.connect(this.processorNode),this.clearStream(),new Promise(e=>{const n=({data:a})=>{a.type==="done"&&(this.processor.removeEventListener("message",n),e())};this.processor.addEventListener("message",n),this.processor.start&&this.processor.start(),this.processor.postMessage({command:"done"})}).then(()=>this.finish())):Promise.resolve()}getState(){return this.state}addWakewordByPath(e,n){return _(this,void 0,void 0,function*(){return this.fetchResource(e,n).then(a=>this.addWakeword(a))})}addWakeword(e){return _(this,void 0,void 0,function*(){return new Promise((n,a)=>{const i=({data:s})=>{switch(s.type){case"wakeword-loaded":return this.processor.removeEventListener("message",i),n();case"wakeword-error":return this.processor.removeEventListener("message",i),a(new Error("Unable to load wakeword"))}};this.processor.addEventListener("message",i),this.processor.postMessage({command:"wakeword",wakewordBytes:e})})})}fetchResource(e,n){return window.fetch(e,{headers:n}).then(a=>a.arrayBuffer())}finish(){this.onstop()}}const oe=Object.freeze(Object.defineProperty({__proto__:null,RustpotterService:L,ScoreMode:p},Symbol.toStringTag,{value:"Module"}));(async()=>{var M,C,q,x,W,R,T,A,O,B,G,H,I,z,U;const l="rustpotter@Demo",e={selectedWakeword:null,selectedWakewordBytes:null,selectedThreshold:.5,selectedAvgThreshold:.2,gainNormalizer:!1,minGain:.5,maxGain:1,gainRef:null,bandPass:!1,bandPassLowCutoff:80,bandPassHighCutoff:400,scoreMode:p.max,minScores:10,rustpotterService:null};window.addEventListener("load",X,{once:!0});try{await Y(),(M=document.querySelector("#wakeword_selector"))==null||M.addEventListener("change",K),(C=document.querySelector("#wakeword_threshold"))==null||C.addEventListener("input",n),(q=document.querySelector("#wakeword_avg_threshold"))==null||q.addEventListener("input",a),(x=document.querySelector("#score_mode_selector"))==null||x.addEventListener("change",J),(W=document.querySelector("#min_scores"))==null||W.addEventListener("input",i),(R=document.querySelector("#gain_normalizer_check"))==null||R.addEventListener("input",s),(T=document.querySelector("#min_gain"))==null||T.addEventListener("input",d),(A=document.querySelector("#max_gain"))==null||A.addEventListener("input",b),(O=document.querySelector("#gain_ref"))==null||O.addEventListener("input",y),(B=document.querySelector("#band_pass_check"))==null||B.addEventListener("input",h),(G=document.querySelector("#low_cutoff"))==null||G.addEventListener("input",u),(H=document.querySelector("#high_cutoff"))==null||H.addEventListener("input",m),(I=document.querySelector("#record"))==null||I.addEventListener("click",F),(z=document.querySelector("#pause"))==null||z.addEventListener("click",V),(U=document.querySelector("#stop"))==null||U.addEventListener("click",$())}catch(t){P(t)}function n(t){e.selectedThreshold=Number(t.target.value)}function a(t){e.selectedAvgThreshold=Number(t.target.value)}function i(t){var c;const r=t.target.value,o=Number((c=t.target.value)==null?void 0:c.trim());e.minScores=r!=null&&r.length&&!isNaN(o)?o:0,v()}function s(t){var r,o;e.gainNormalizer=t.target.checked,e.gainNormalizer?(r=document.querySelector("#gain_normalizer_options"))==null||r.classList.remove("hidden"):(o=document.querySelector("#gain_normalizer_options"))==null||o.classList.add("hidden"),v()}function d(t){e.minGain=Number(t.target.value)}function b(t){e.maxGain=Number(t.target.value)}function y(t){var c;const r=t.target.value,o=Number((c=t.target.value)==null?void 0:c.trim());e.gainRef=r!=null&&r.length&&!isNaN(o)?o:null,v()}function h(t){var r,o;e.bandPass=t.target.checked,e.bandPass?(r=document.querySelector("#band_pass_options"))==null||r.classList.remove("hidden"):(o=document.querySelector("#band_pass_options"))==null||o.classList.add("hidden"),v()}function u(t){var c;const r=t.target.value,o=Number((c=t.target.value)==null?void 0:c.trim());e.bandPassLowCutoff=r!=null&&r.length&&!isNaN(o)?o:null,v()}function m(t){var c;const r=t.target.value,o=Number((c=t.target.value)==null?void 0:c.trim());e.bandPassHighCutoff=r!=null&&r.length&&!isNaN(o)?o:null,v()}function $(){return async()=>{var t;S(!1),(t=e.rustpotterService)==null||t.stop().then(()=>{var r;return(r=e.rustpotterService)==null?void 0:r.close()}).then(()=>{e.rustpotterService=null,f("record"),E(!0)}).catch(r=>{k(r.message??r)})}}function V(){var t;S(!1),(t=e.rustpotterService)==null||t.pause().then(()=>{f("record")}).catch(r=>{k(r.message??r)})}async function F(){try{if(f("record",!1),E(!1),e.rustpotterService!=null){e.rustpotterService.resume(),f("pause"),f("stop");return}const t=new URL("/rustpotter-worklet-demo/assets/rustpotter_wasm_bg-7ddf829b.wasm",self.location),r=new URL("/rustpotter-worklet-demo/assets/rustpotter-worklet.min-c08bdf63.js",self.location);e.rustpotterService=new L({workletPath:r.href,wasmPath:t.href,averagedThreshold:e.selectedAvgThreshold,threshold:e.selectedThreshold,scoreMode:e.scoreMode,minScores:e.minScores,gainNormalizerEnabled:e.gainNormalizer,minGain:e.minGain,maxGain:e.maxGain,gainRef:e.gainRef??void 0,bandPassEnabled:e.bandPass,bandPassLowCutoff:e.bandPassLowCutoff??80,bandPassHighCutoff:e.bandPassHighCutoff??400}),e.rustpotterService.onspot=o=>{const c=new Date;let w=`${c.getHours().toString().padStart(2,"0")}:${c.getMinutes().toString().padStart(2,"0")}:${c.getSeconds().toString().padStart(2,"0")}`;g(`[T${w}] ${JSON.stringify(o)}`)},e.rustpotterService.onstart=function(){g("rustpotterService is started")},e.rustpotterService.onstop=function(){g("rustpotterService is stopped")},e.rustpotterService.onpause=function(){g("rustpotterService is paused")},e.rustpotterService.onresume=function(){g("rustpotterService is resumed")},await e.rustpotterService.start(),e.selectedWakeword=="manual"?e.selectedWakewordBytes&&await e.rustpotterService.addWakeword(e.selectedWakewordBytes):e.selectedWakeword&&await e.rustpotterService.addWakewordByPath(e.selectedWakeword),f("pause"),f("stop")}catch(t){P(t)}}function J(t){switch(t.target.value){case"Avg":e.scoreMode=p.avg;break;case"Median":e.scoreMode=p.median;break;case"Max":e.scoreMode=p.max;break;case"P25":e.scoreMode=p.p25;break;case"P50":e.scoreMode=p.p50;break;case"P75":e.scoreMode=p.p75;break;case"P80":e.scoreMode=p.p80;break;case"P90":e.scoreMode=p.p90;break;case"P95":e.scoreMode=p.p95;break}}function K(t){var o,c;const r=t.target.value;if(e.selectedWakewordBytes=null,r=="manual"){S(!1);const w=document.querySelector("#wakeword_input_container");w&&(w.innerHTML+='<input id="wakeword_input" type="file" accept=".rpw">'),(o=document.querySelector("#wakeword_input"))==null||o.addEventListener("change",Q)}else(c=document.querySelector("#wakeword_input"))==null||c.remove(),f("record");e.selectedWakeword=r}function Q(t){const r=new FileReader;r.onload=function(){e.selectedWakewordBytes=this.result,f("record")},r.onerror=function(){k("Unable to read wakeword file."),S(!1)},this.files&&r.readAsArrayBuffer(this.files[0])}function v(){const t=["min_scores"];e.gainNormalizer&&t.push("gain_ref"),e.bandPass&&(t.push("low_cutoff"),t.push("high_cutoff")),f("record",t.every(r=>{var o;return(o=document.querySelector(`#${r}`))==null?void 0:o.validity.valid}))}function X(){g("this is a demo web site for testing the library spot capabilities"),g("loading available wakewords..."),S(!1),E(!1);const t=document.querySelector("#rustpotter_version");t&&(t.innerHTML="rustpotter-v2.0.0",t.href="https://github.com/GiviMAD/rustpotter-cli/releases/tag/v2.0.0"),fetch("wakewords.json").then(r=>r.json()).then(r=>{const o=document.querySelector("#wakeword_selector"),c=Object.entries(r);o&&(c.forEach(w=>{o.innerHTML+='<option value="'+w[1]+'">'+w[0]+"</option>"}),o.innerHTML+='<option value="manual">from file...</option>',e.selectedWakeword=c[0][1],o.disabled=!1),E(!0),f("record"),g("wakewords list loaded")}).catch(r=>{k(r.message??r),S(!1)})}async function Y(){const{RustpotterService:t}=await te(()=>Promise.resolve().then(()=>oe),void 0);if(!t.isRecordingSupported()){const r="Unable to record in this browser :(";throw alert(r),new Error(r)}}function f(t,r=!0){const o=document.querySelector("#"+t);o&&(o.disabled=!r)}function E(t){var r;(r=document.querySelector("#wakeword_panel"))==null||r.querySelectorAll("input,select").forEach(o=>o.disabled=!t)}function S(t){var r;(r=document.querySelector("#btn_panel"))==null||r.querySelectorAll("button").forEach(o=>o.disabled=!t)}function g(t){console.log(t);const r=document.querySelector("#terminal");r&&(r.innerHTML+='<span style="color: grey">'+l+'</span> % <span class="ok">'+t+"</span><br>",r.parentElement&&(r.parentElement.scrollTop=r.parentElement.scrollHeight))}function k(t,r=!0){r&&console.error(t);const o=document.querySelector("#terminal");o&&(o.innerHTML+='<span style="color: grey">'+l+'</span> % <span class="error">'+t+"</span><br>",o.parentElement&&(o.parentElement.scrollTop=o.parentElement.scrollHeight))}function P(t){console.error(t),k(t instanceof Error?"unexpected error:"+t.message:t+"",!1)}})();
